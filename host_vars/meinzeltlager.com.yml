---
roles:
  - defaults
  - sshd
  - caddy
  - postgresql
  - mail
  - php
  - mysql
  - nftables
  - network
  - phpmyadmin
  - prometheus
  - prometheus_script_exporter
  - prometheus_telegram_bot
  - mediawiki
  - sentry
  - zeltlager_website
  - zeltlager_app
  - wireguard

prometheus_server: True
# WireGuard server
# Own public key: bRVwKOi8icAUncwN29zeXerzj0WEVcsxdTd6pd29Fi4=
local_prometheus_ip: 10.2.0.1
wireguard_configs:
  - name: promet_server
    address: "{{ local_prometheus_ip }}/24"
    listen_port: "{{ wireguard_prometheus_port }}"
    private_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      31323335633732383635636335313732633365386466646532353938646565666333643762386564
      3761623938343832363731616136646233393134656534620a313063373462386664306333663635
      66353266646666613336623037356263353834656132306636386134353665323931303062376633
      6663366663383335390a306434613338373064633964393437613734656361366332353137386632
      35613039616137653839353638366261376238323734376133616430646361643166383265396565
      3335343731333437363535643066623366346436356435306265
    peers:
      - name: A
        public_key: "wRbaMurAZw3luWX+tWcZBMIS4cA17yjO18sTkCkMX1g="
        allowed_ips: 10.2.0.2
      - name: B
        public_key: "LxtAU/5ITFAYsBVRJLZ0l8y2TWnby5GrZyVRfQxo/0M="
        allowed_ips: 10.2.0.3
      - name: C
        public_key: "gTsYH0Rm8dGIoGM45p90TrWG23Fv8R74B35HjcxDvis="
        allowed_ips: 10.2.0.4

wireguard_service_before:
  promet_server: [prometheus-blackbox-exporter, prometheus-node-exporter, prometheus-script-exporter,
    caddy]

caddy_user: http
caddy_conf_file: caddy.conf
caddy_sites:
  mail.meinzeltlager.com: |
    mail.meinzeltlager.com {
      redir https://meinzeltlager.com
    }

  meinzeltlager.com: |
    meinzeltlager.com {
      import ../defaults
      import ../ssl_defaults
      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' data:; form-action 'self'; frame-ancestors 'self'"

      proxy / localhost:{{ zeltlager_website_port }} {
        transparent
      }
    }

    meinzeltlager.com/google9cea32bbccdb1ab4.html {
      import ../defaults
      import ../ssl_defaults
      rewrite {
        to /google9cea32bbccdb1ab4.html
      }
      root /srv/http/html
    }

    meinzeltlager.com/googlebc9427e754b6efbc.html {
      import ../defaults
      import ../ssl_defaults
      rewrite {
        to /googlebc9427e754b6efbc.html
      }
      root /srv/http/html
    }

    www.meinzeltlager.com {
      redir 301 {
        / https://meinzeltlager.com{uri}
        }
    }

  wiki.meinzeltlager.com: |
    wiki.meinzeltlager.com {
      import ../defaults
      import ../ssl_defaults
      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data:; form-action 'self'; frame-ancestors 'self'"

      root /usr/share/webapps/mediawiki
      fastcgi / /run/php-fpm/php-fpm.sock php {
        except /images
      }
      status 404 /images/deleted
      rewrite /wiki {
        r /(.*)
        to /index.php?title={1}
      }
    }

  discourse.meinzeltlager.com: |
    discourse.meinzeltlager.com {
      import ../defaults
      import ../ssl_defaults
      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data:; form-action 'self'; frame-ancestors 'self'"

      proxy / localhost:{{ discourse_port }} {
        transparent
      }
    }

  sentry.meinzeltlager.com: |
    sentry.meinzeltlager.com {
      import ../defaults
      import ../ssl_defaults
      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data:; form-action 'self'; frame-ancestors 'self'"

      proxy / localhost:{{ sentry_port }} {
        transparent
      }
    }

  webapps: |
    *:8080 {
      import ../defaults
      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' data: ws:"
      bind 127.0.0.1

      root /usr/share/webapps
      fastcgi / /run/php-fpm/php-fpm.sock php
    }

  services: |
    http://services.meinzeltlager.com:{{ caddy_services_port }} {
      # The site needs to be visited at least once so the stats get included
      #prometheus {
        #address {{ local_prometheus_ip }}:{{ caddy_prometheus_exporter_port }}
      #}
      import ../defaults
      bind {{ local_prometheus_ip }}

      #cgi / /srv/http/services.sh
    }

    http://prometheus.services.meinzeltlager.com:{{ caddy_services_port }} {
      #prometheus {
        #address {{ local_prometheus_ip }}:{{ caddy_prometheus_exporter_port }}
      #}
      import ../defaults
      bind {{ local_prometheus_ip }}

      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: ws:; form-action 'self'; frame-ancestors 'self'"
      proxy / 127.0.0.1:{{ prometheus_port }} {
        transparent
      }
    }

    http://alertmanager.services.meinzeltlager.com:{{ caddy_services_port }} {
      #prometheus {
        #address {{ local_prometheus_ip }}:{{ caddy_prometheus_exporter_port }}
      #}
      import ../defaults
      bind {{ local_prometheus_ip }}

      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: ws:; form-action 'self'; frame-ancestors 'self'"
      proxy / 127.0.0.1:{{ alertmanager_port }} {
        transparent
      }
    }

    http://grafana.services.meinzeltlager.com:{{ caddy_services_port }} {
      #prometheus {
        #address {{ local_prometheus_ip }}:{{ caddy_prometheus_exporter_port }}
      #}
      import ../defaults
      bind {{ local_prometheus_ip }}

      header / Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: ws:; form-action 'self'; frame-ancestors 'self'"
      proxy / 127.0.0.1:{{ grafana_port }} {
        transparent
      }
    }

    http://rspamd.services.meinzeltlager.com:{{ caddy_services_port }} {
      #prometheus {
        #address {{ local_prometheus_ip }}:{{ caddy_prometheus_exporter_port }}
      #}
      import ../defaults
      bind {{ local_prometheus_ip }}

      header / Content-Security-Policy "default-src 'self' 'unsafe-inline'; form-action 'self'; frame-ancestors 'self'"
      proxy / 127.0.0.1:{{ rspamd_port }} {
        transparent
      }
    }

nftables_config: |
  table ip filter {
    chain prerouting {
      type nat hook prerouting priority 0;
      iifname promet_server tcp dport 80 redirect to :{{ caddy_services_port }}
    }
  }

  table inet filter {
    chain input {
      type filter hook input priority 0; policy drop;

      # Allow established/related connections
      ct state {established, related} accept
      # Drop of invalid connections
      ct state invalid drop

      # Allow loopback
      iifname lo accept
      # Allow WireGuard
      iifname promet_server accept

      # Drop invalid packets
      iifname != lo ip daddr 127.0.0.1/8 drop
      iifname != lo ip6 daddr ::1/128 drop

      # Allow icmp
      ip protocol icmp accept
      ip6 nexthdr icmpv6 accept

      # Web
      tcp dport { 80, 443 } accept

      # Mail: SMTP, IMAP, SMTP submission, IMAPS
      tcp dport { 25, 143, 587, 993 } limit rate 15/minute accept

      # WireGuard
      udp dport {{ wireguard_prometheus_port }} accept

      # Allow ssh and avoid brute force
      tcp dport {{ sshd_port }} limit rate 15/minute accept
    }

    chain forward {
      type filter hook forward priority 0; policy accept;
    }

    chain output {
      type filter hook output priority 0;
    }
  }

sshd_host_settings:
  - regexp: "^#?AllowUsers "
    line: AllowUsers ansible zeltlager alina

postgresql_hba_entries:
  - { type: local, database: all, user: postgres, auth_method: peer }
  - { type: local, database: all, user: all, auth_method: peer }
  - { type: host, database: all, user: all, address: '127.0.0.1/32', auth_method: md5 }
  - { type: host, database: all, user: all, address: '::1/128', auth_method: md5 }
  - { type: host, database: all, user: all, address: '10.2.0.0/24', auth_method: md5 }

postgresql_global_config_options:
  - option: unix_socket_directories
    value: '{{ postgresql_unix_socket_directories | join(",") }}'
  - option: listen_addresses
    value: '*'

php_settings:
  - regexp: "^;?upload_max_filesize"
    line: upload_max_filesize = 5M
php_extensions:
  - mysqli
  - pgsql
  - pdo_mysql
  - pdo_pgsql
  - gd
  - intl
  - iconv

postgres_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  62303132373663626233643531353565336166653032333364653038396534373336383535633336
  3036386566346466663064663363666336616531656664640a313663356434653638383433313365
  34623439616436643338303165323564646430356661356561306636386131646165393730363464
  3931613036643232630a393361353833643661356661626463303136336161313463613136663136
  65633035393732656434306438626138306330343737666265653166623035393562

mysql_root_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  37373839653963633961643937333336663530316662326665303230616237323837343538656264
  3066343839616161616234383531323434333565346433630a303335383362376261653535613830
  61313833333435326162336161366136663363386662363364353439303335383366376466353663
  3037333863616331660a396334643863393638643733383533626663666661613065393631643633
  64386136336331303962373632393736313936663365363561633461346266616534

postfix_db_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  30623766646536663165626634366234366133643363326437393734393536663431313335653233
  3537613465623433343838666131643039653833306265370a353236346534643838333130376163
  32353864626139343732396535313431333162623262393537356337323164306537356663613166
  3331333632383738380a643131313531343332396139386431353434373230363566396363363161
  33386537656666346338663166623933353733653632373631663362393563333138

zeltlager_db_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  66323265313036366262663662356438366137646639376339653461303235633131363737343862
  6163653762393963383333626331653163643961346438330a396437366265376231316366336537
  30623333313330626561373563373637306232613233626161346435303833386431663563623631
  3864666462363065300a653266373662313336663461343637373861373461663237666563336630
  64386136303466623838356164393231346134303232353965663361383031376137
zeltlager_website_mail_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  61663162303866386531383031633465396661613039346136366235633164653537316264623563
  3462613563653639366639663162373566326536356333650a613538636466396136386464373635
  36613561323731343664633365653533386130636564336531396632383031333939356634633535
  3632353633643761320a366236383039666363343738666437353463373061373739643862376131
  36663362326534663936633235643531306161336430366262366533393638393536

mediawiki_db_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  66663335383166663633303331303233623866356436383432656162326361353236653731623330
  3533363935343065663332363431623161633766633835610a666230363830353733623965316639
  33373831633539633566363563343630343464353361396465373638383663626664666338633465
  3033363637316235630a663637346364333462353634663266323534376162356363363461376466
  65323531353130333436623637653461386230366161343034373937386230313264
mediawiki_secret_key: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  64623538383063623138313933666561323663643838613834643863666161393739396138623738
  6433623937333030336633336633336332303732306130320a663539666330373237396238386264
  30383763323836316238613661316137653866343338666638386130656134313633373161393330
  3234366533366630370a653630343636326331376364343339383433613131653836363964336136
  37376538396134373134613863366664666135313931616533386130633333663438386332383838
  38303938346136396364623065386566613365656532666666376431343833626537623264643332
  32356265636331343833393437643934376138633836643462303836316665323661333535303764
  62643762656238633239
mediawiki_upgrade_key: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  64336638386636666664623636616638336461663261613962333165333333653033373334353531
  6437333333363663303638383561383162656431653530320a323063396561636364336237613334
  30623766336634303962633833376664613436313766643535636461373166663937376533623439
  3633373733633532610a333431363534326664306633373565643531326662313832646266636535
  66336137666262303539633366393731366264616536616638383766643839373263
mediawiki_mail_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  31333638386134636562306235326637653566393337613738376633333732303963333463373761
  3863316136333961666362336665303864646263663536620a343839643264643037646630363337
  32306565613036646539356565306138653762343766346336613432646539313739633136393032
  3533383035333862310a316637396530323932613061383830383835303364666434383461323036
  34313031646535666264663762383639343166353562393839633831616462326532

alertmanager_mail_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  62373633623831626433353662653361343864646633663564346537306239623936643334346333
  3231663732353535393437313335373766356261373263350a353566663831336563303432326430
  34653834373732363866626131653539316439316338313431366636333864346239376265623431
  6139386231383839300a346462643064316431386464376334316633313865366562613665616161
  63343664646131386439343431363636626461323766616536353966653631656637
grafana_db_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  63373963663938333936383564303362313139616664343863646333616637663539363431616533
  3561346564336365353133633535386537633562623938350a306438633631353036393235343736
  32326430363865366366616133336239323032363462393163363330653831326561323835623230
  3432383962336630640a653637656637616465663633383363313463303737646235643337663832
  33353365323237316633396131373836623562376664373235646234383432636632
grafana_admin_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  35306438353261313934303731363939306634393537353864333538366264363464653766323731
  6638386433373366343139613835333833626238353462340a373039653364633338663935346330
  64316439366134643961383233303865396165366436643663376537366236373463353133633265
  6335353261316266630a383334346334346636376164376262376164626638663037313736656331
  62323561613734326266336462633031656531633433656630363263613964373135

test_mail: test@{{ mail_domain }}
ldap_test_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  32383061663266643034373131316239643734353931353066646639323564393231666236383936
  3763303239346630623463633065663237346339326538380a323632343764346436303762313632
  30363636643939643961623037363639363564393465323832666234343438353634666631616330
  6333323034383832390a343130343538306137656664613034316666313538363535343530656562
  30636163373835356331613433653166303938613435643739353761633831646230

discourse_mail_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  66333861626132366564376264306231383762356534386131663466353965356235653864313031
  3466653037333634323665306239363166633332333562610a626531626164343565393365396332
  38313636323466666437386538653033363637613038636164646562333364326337653436323065
  3537363961653261630a666238646238663864396436613536316232623666636565643036393765
  39396631653762633265333534356336636538643031333639663130656663373139

discourse_group: Test
discourse_category: Test
discourse_user: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  61313831626135366562643632626662386533623765306435666139613263623463303466303961
  6266626462373464333264346239393437393465353962360a326134303336303934393332643461
  31386162363537343730303631646434663531306561343364303832396631313235393235383434
  3163623539303638660a393737643532343765393965656565346262356339316630306436376131
  6665
discourse_token: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  63356663303934386265646232396361316336356433643038663065373031616464333638353235
  3161383835396234656535306464646264663235393063360a633638343239393935386562353861
  31623533346565636538366561396631333834633633666430343333313737363437353831366431
  3233653939666561640a646532643730303432623664393633663964356131313363346632373766
  33306638353436666634626438313237613163356438646438373461386465633461633863653237
  34383566373039323438313438303737396238626135636361663131626531636661653136336336
  30623339393430643231316631333062323434313032336563393332303638336261663234643463
  63353866356663333931

sentry_db_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  32363738303334376337663762616463393561373832343236326537636433636162663536356662
  3962323965633834616563396532383439656534356266340a373739636637633438626139636239
  66663238666265383430316635376663343964303530643838303630383862326433346464386330
  6132633337613437390a373033663835623930383763393132313538656366323738663762393431
  39643765353966323835643166636234633439343866393137626131363332663366
sentry_secret: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  31663232356639616437656539653333376266326363373261666265393235633931643333376262
  3938383162633564653731323264643139373731623430660a303035623363366234336261363164
  62356262663765613665353937383839653537653030303037396332626134666333373861653464
  6331393030666230660a623063346632646635666234373435336635616137396463656237643338
  65376533353234613865373866306132343665346565643862636533343063303935366331346538
  36653431623963356232623366353165383130363034656336373531656134616235653936663461
  613631623839616433666535653233356463
sentry_mail_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  62393435323965333236353739653464386632386533316633383463306436303139646133363939
  3033363934396364303864313637396163643462333537630a643663383465393265653735353036
  32656439373064383061383630643963326366336134633462633264666461396132323935363962
  3136336262303232610a346164336166636432376263366161363530393731336435636463633437
  62303834623935363066343261356263313463653366316538376262356236383736
sentry_dsn: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  62626237653736633133613232373361313131313938356261336361343738376339346461343366
  3263666266316366363432316263383361383964626437640a363234323839313535373631346638
  62653230646135356434363935623034383861306433376437636138396233306532376134666332
  3234663861333130630a613933306434356433333165613735653436643861383136343536326662
  34306434633131653539633633366439376234383531366663613066366639626535356332306561
  61653534656165396665316334343835643535393764646437656639316665613565633364323236
  30316563663563303032383433303639333139356663663766646462663634633631643032316263
  62666534386238636465
